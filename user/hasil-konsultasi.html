<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- icon -->
    <link
      rel="shortcut icon"
      href="../assets/img/favicon.ico"
      type="image/x-icon"
    />

    <title>Hasil Konsultasi - User</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link href="../assets/css/style.css" rel="stylesheet" />
  </head>
  <body>
    <div class="container-fluid">
      <div class="row g-0">
        <!-- Sidebar -->
        <aside class="col-md-3 col-lg-2 sidebar">
          <div class="sidebar-header p-3 d-flex align-items-center mb-2">
            <img
              src="../assets/img/logo.png"
              alt="Logo"
              class="logo-img me-2"
            />
            <span class="brand-name">SiKonsultasiBumil</span>
          </div>
          <div class="sidebar-menu px-2">
            <p
              class="sidebar-heading px-3 text-uppercase text-muted small fw-bold"
            >
              Menu Utama
            </p>
            <ul class="nav nav-pills flex-column gap-1">
              <li class="nav-item">
                <a class="nav-link" href="dashboard.html"
                  ><i class="bi bi-grid me-2"></i><span>Dashboard</span></a
                >
              </li>
              <li class="nav-item">
                <a class="nav-link" href="konsultasi.html"
                  ><i class="bi bi-chat-heart me-2"></i
                  ><span>Konsultasi</span></a
                >
              </li>
              <li class="nav-item">
                <a class="nav-link" href="riwayat.html"
                  ><i class="bi bi-clock-history me-2"></i
                  ><span>Riwayat Konsultasi</span></a
                >
              </li>
              <li class="nav-item">
                <a class="nav-link" href="biodata.html"
                  ><i class="bi bi-person-circle me-2"></i
                  ><span>Biodata</span></a
                >
              </li>
            </ul>
            <p
              class="sidebar-heading px-3 text-uppercase text-muted small fw-bold mt-4"
            >
              Akun
            </p>
            <ul class="nav nav-pills flex-column gap-1 mb-3">
              <li class="nav-item">
                <a class="nav-link text-danger" href="../login.html"
                  ><i class="bi bi-box-arrow-left me-2"></i
                  ><span>Logout</span></a
                >
              </li>
            </ul>
          </div>
        </aside>

        <!-- Main Content -->
        <main class="col-md-9 col-lg-10 main-content p-0">
          <!-- Header -->
          <header
            class="header p-3 border-bottom d-flex justify-content-between align-items-center"
          >
            <div class="d-flex align-items-center">
              <button
                class="btn btn-sm btn-outline-secondary border-0 d-md-none me-2"
                id="sidebarToggle"
              >
                <i class="bi bi-list"></i>
              </button>
              <h5 class="mb-0">Hasil Konsultasi</h5>
            </div>
            <div class="d-flex align-items-center gap-2">
              <a href="konsultasi.html" class="btn btn-sm btn-outline-primary"
                ><i class="bi bi-arrow-left me-1"></i>Kembali</a
              >
              <div class="dropdown">
                <a
                  class="btn btn-light border-0 dropdown-toggle position-relative"
                  href="#"
                  role="button"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  <i class="bi bi-bell"></i>
                  <span
                    class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                    >1</span
                  >
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><h6 class="dropdown-header">Notifikasi</h6></li>
                  <li><a class="dropdown-item" href="#">Hasil tersimpan</a></li>
                  <li><hr class="dropdown-divider" /></li>
                  <li>
                    <a class="dropdown-item" href="#">Lihat semua notifikasi</a>
                  </li>
                </ul>
              </div>
            </div>
          </header>

          <!-- Content -->
          <div class="content p-4" id="hasilContent">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <h5 class="mb-0">Ringkasan Hasil Konsultasi</h5>
                <small class="text-secondary">Dokumen ini dapat diunduh sebagai PDF.</small>
              </div>
              <button class="btn btn-danger" id="downloadPdfBtn">
                <i class="bi bi-file-earmark-pdf me-1"></i> Download PDF
              </button>
            </div>
            <div class="row g-3">
              <div class="col-lg-8">
                <div class="card shadow-sm">
                  <div class="card-body">
                    <h6 class="fw-bold mb-3">Ringkasan Pasien</h6>
                    <div class="row g-2 small">
                      <div class="col-md-6"><span class="text-secondary">Nama Ibu:</span> <span id="patientName">-</span></div>
                      <div class="col-md-6"><span class="text-secondary">Usia Kehamilan:</span> <span id="gestAge">-</span></div>
                      <div class="col-md-6"><span class="text-secondary">Tanggal Konsultasi:</span> <span id="consultDate">-</span></div>
                      <div class="col-md-6"><span class="text-secondary">No. Rekam Medis:</span> <span id="noRm">-</span></div>
                    </div>
                  </div>
                </div>
                <div class="card shadow-sm">
                  <div class="card-body">
                    <h5 class="fw-bold">Diagnosis Awal</h5>
                    <p class="text-secondary mb-2">Kemungkinan: <span id="diagnosisName">-</span> <span class="badge text-bg-warning ms-1" id="diagnosisConfidence">-</span></p>
                    <div class="alert alert-info mb-0">
                      Catatan: Ini adalah hasil simulasi statis untuk tujuan UI.
                      Integrasi backend akan memberikan hasil aktual berdasarkan
                      rule pakar.
                    </div>
                  </div>
                </div>
                <div class="card shadow-sm">
                  <div class="card-body">
                    <h6 class="fw-bold">Gejala Terkonfirmasi</h6>
                    <ul id="symptomsList" class="mb-0"></ul>
                  </div>
                </div>
              </div>
              <div class="col-lg-4">
                <div class="card shadow-sm">
                  <div class="card-body">
                    <h6 class="fw-bold">Saran</h6>
                    <ul class="mb-0" id="adviceList"></ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
    <script src="../assets/js/script.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        // Data dummy (fallback bila tidak ada data dari halaman konsultasi)
        const dummy = {
          patient: { name: 'Ibu Siti Aisyah', gestationalWeeks: 24, noRm: 'RM-00123' },
          consultAt: new Date(),
          symptoms: ['Mual berlebihan', 'Pusing atau pingsan'],
          diagnosis: { name: 'Anemia Ringan', confidence: 0.72 },
          advice: [
            'Perbanyak asupan zat besi',
            'Istirahat cukup',
            'Periksa ke puskesmas bila gejala berat'
          ]
        };

        // Ambil data dari localStorage jika ada (mis. diset halaman konsultasi), jika tidak pakai dummy
        let data;
        try {
          data = JSON.parse(localStorage.getItem('hasilKonsultasi') || 'null') || dummy;
        } catch (_) { data = dummy; }

        // Render ke UI
        const setText = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };
        setText('patientName', data.patient?.name || '-');
        setText('gestAge', data.patient?.gestationalWeeks ? `${data.patient.gestationalWeeks} minggu` : '-');
        setText('noRm', data.patient?.noRm || '-');
        const d = data.consultAt ? new Date(data.consultAt) : new Date();
        setText('consultDate', d.toLocaleString());
        setText('diagnosisName', data.diagnosis?.name || '-');
        const conf = data.diagnosis?.confidence;
        setText('diagnosisConfidence', (typeof conf === 'number') ? `${Math.round(conf * 100)}%` : '-');

        const symWrap = document.getElementById('symptomsList');
        if (symWrap) {
          symWrap.innerHTML = '';
          (data.symptoms || []).forEach((s) => {
            const li = document.createElement('li');
            li.textContent = s;
            symWrap.appendChild(li);
          });
          if (!symWrap.children.length) {
            const li = document.createElement('li');
            li.className = 'text-secondary';
            li.textContent = 'Tidak ada gejala terkonfirmasi.';
            symWrap.appendChild(li);
          }
        }

        const advWrap = document.getElementById('adviceList');
        if (advWrap) {
          advWrap.innerHTML = '';
          (data.advice || []).forEach((a) => {
            const li = document.createElement('li');
            li.textContent = a;
            advWrap.appendChild(li);
          });
        }

        // PDF export
        const btn = document.getElementById('downloadPdfBtn');
        const target = document.getElementById('hasilContent');
        btn?.addEventListener('click', () => {
          if (!target) return;
          const now = new Date();
          const pad = (n) => String(n).padStart(2, '0');
          const filename = `Hasil-Konsultasi-${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}-${pad(now.getHours())}${pad(now.getMinutes())}.pdf`;
          const opt = {
            margin: [10, 10, 10, 10],
            filename,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
          };
          html2pdf().from(target).set(opt).save();
        });
      });
    </script>
      });
    </script>
  </body>
</html>
